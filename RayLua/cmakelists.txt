cmake_minimum_required(VERSION 3.21)
cmake_policy(VERSION 3.5)
set(CMAKE_GENERATOR_PLATFORM Win32)
set(CMAKE_VERBOSE_MAKEFILE ON)
set(CMAKE_SIZEOF_VOID_P 4)
project(raylib_lua_imgui C CXX)

set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

# Raylib
FetchContent_Declare(raylib
        URL https://github.com/raysan5/raylib/archive/refs/tags/5.5.tar.gz
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(raylib)

# ImGui
FetchContent_Declare(imgui
        URL https://github.com/ocornut/imgui/archive/refs/tags/v1.92.1.tar.gz
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(imgui)

add_library(imgui_lib
        ${imgui_SOURCE_DIR}/imgui.cpp
        ${imgui_SOURCE_DIR}/imgui_demo.cpp
        ${imgui_SOURCE_DIR}/imgui_draw.cpp
        ${imgui_SOURCE_DIR}/imgui_tables.cpp
        ${imgui_SOURCE_DIR}/imgui_widgets.cpp
)
target_include_directories(imgui_lib PUBLIC ${imgui_SOURCE_DIR})

# RlImGui
FetchContent_Declare(rlimgui
        GIT_REPOSITORY https://github.com/raylib-extras/rlImGui.git
        GIT_TAG 4d8a618
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(rlimgui)

add_library(rlimgui_lib ${rlimgui_SOURCE_DIR}/rlImGui.cpp)
target_include_directories(rlimgui_lib PUBLIC
        ${rlimgui_SOURCE_DIR}
        ${imgui_SOURCE_DIR}
        ${raylib_SOURCE_DIR}/src
)
target_link_libraries(rlimgui_lib imgui_lib raylib)

# LuaJIT
add_library(luajit_lib STATIC IMPORTED)
set_target_properties(luajit_lib PROPERTIES
        IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src/lua51.lib
)
target_include_directories(luajit_lib INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src)

# Core files - explicit list
set(CORE_SOURCES
        core/mapcore.c
        core/kplib.c
        # Add other .c files here
)

set(CORE_HEADERS
        core/mapcore.h
        core/loaders.h
        core/kplib.h
        # Add other .h files here
)

# Main executable
add_executable(game
        main.cpp
        FileWatcher.h
        ${CORE_SOURCES}
        ${CORE_HEADERS}
)

target_compile_definitions(game PRIVATE
        USEHEIMAP=0
        NOSOUND=0
        OOS_CHECK=0
        WIN32
        _WINDOWS
        _X86_
)

target_include_directories(game PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/core
        ${rlimgui_SOURCE_DIR}
        ${imgui_SOURCE_DIR}
        ${raylib_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src
)

target_link_libraries(game
        raylib
        imgui_lib
        rlimgui_lib
        luajit_lib
)

# Copy script
configure_file(script.lua ${CMAKE_CURRENT_BINARY_DIR}/script.lua COPYONLY)
