cmake_minimum_required(VERSION 3.16)
project(raylib_lua_imgui C CXX)
# Force x86 architecture
set(CMAKE_GENERATOR_PLATFORM Win32)
set(CMAKE_SIZEOF_VOID_P 4)
set(CMAKE_C_STANDARD 11)
set(CMAKE_CXX_STANDARD 17)

include(FetchContent)

# Fetch raylib
FetchContent_Declare(raylib
        URL https://github.com/raysan5/raylib/archive/refs/tags/5.5.tar.gz
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(raylib)

# Fetch Dear ImGui
FetchContent_Declare(imgui
        URL https://github.com/ocornut/imgui/archive/refs/tags/v1.92.1.tar.gz
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(imgui)

add_library(imgui_lib
        ${imgui_SOURCE_DIR}/imgui.cpp
        ${imgui_SOURCE_DIR}/imgui_demo.cpp
        ${imgui_SOURCE_DIR}/imgui_draw.cpp
        ${imgui_SOURCE_DIR}/imgui_tables.cpp
        ${imgui_SOURCE_DIR}/imgui_widgets.cpp
)

FetchContent_Declare(rlimgui
        GIT_REPOSITORY https://github.com/raylib-extras/rlImGui.git
        GIT_TAG 4d8a618
        DOWNLOAD_EXTRACT_TIMESTAMP TRUE
)
FetchContent_MakeAvailable(rlimgui)

target_include_directories(imgui_lib PUBLIC ${imgui_SOURCE_DIR})

add_library(rlimgui_lib
        ${rlimgui_SOURCE_DIR}/rlImGui.cpp
)

target_include_directories(rlimgui_lib PUBLIC
        ${rlimgui_SOURCE_DIR}
        ${imgui_SOURCE_DIR}
        ${raylib_SOURCE_DIR}/src
)

target_link_libraries(rlimgui_lib imgui_lib raylib)

# Use prebuilt LuaJIT
add_library(luajit_lib STATIC IMPORTED)
set_target_properties(luajit_lib PROPERTIES
        IMPORTED_LOCATION ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src/lua51.lib
)

# Set LuaJIT include directory
target_include_directories(luajit_lib INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src)

add_executable(game main.cpp
        FileWatcher.h)

add_custom_command(TARGET game POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        ${CMAKE_SOURCE_DIR}/script.lua
        $<TARGET_FILE_DIR:game>/script.lua
)

target_include_directories(game PRIVATE
        ${rlimgui_SOURCE_DIR}
        ${imgui_SOURCE_DIR}
        ${raylib_SOURCE_DIR}/src
        ${CMAKE_CURRENT_SOURCE_DIR}/External/LuaJIT/src
)

target_link_libraries(game
        raylib
        imgui_lib
        rlimgui_lib
        luajit_lib
)

configure_file(script.lua ${CMAKE_CURRENT_BINARY_DIR}/script.lua COPYONLY)
